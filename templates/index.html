pip install -r requirements.txt<!doctype html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OCR 前端示例</title>
    <style>
      body{font-family:Segoe UI, Roboto, sans-serif; max-width:800px;margin:40px auto;padding:0 16px}
      .result{white-space:pre-wrap;background:#f6f6f6;padding:12px;border-radius:6px;margin-top:12px}
    </style>
  </head>
  <body>
    <h2>OCR 前端示例</h2>
    <p>选择图片后点击“上传并识别”，识别结果会显示在下方。</p>

    <form id="uploadForm">
      <div>
        <input type="file" id="imageInput" name="image" accept="image/*" required />
      </div>
      <div style="margin-top:8px">
        <input type="text" id="prompt" name="prompt" placeholder="提示词（可选）" style="width:60%" value="{{ default_prompt }}" />
      </div>
      <div style="margin-top:12px">
        <button type="submit">上传并识别</button>
      </div>
    </form>

    <h3>识别结果</h3>
    <div id="result" class="result">（等待识别）</div>

    <h3>调试信息</h3>
    <div id="debug" class="result" style="background:#fff8e1;color:#222">
      <div><strong>状态：</strong><span id="status">-</span></div>
      <div><strong>耗时：</strong><span id="elapsed">-</span> ms</div>
      <div><strong>响应 JSON：</strong></div>
      <pre id="rawJson" style="max-height:200px;overflow:auto;background:#f0f0f0;padding:8px"></pre>
      <div><strong>原始响应文本（若非 JSON）：</strong></div>
      <pre id="rawText" style="max-height:200px;overflow:auto;background:#f0f0f0;padding:8px"></pre>
    </div>

    <script>
      const form = document.getElementById('uploadForm');
      const resultEl = document.getElementById('result');

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const fileInput = document.getElementById('imageInput');
        if (!fileInput.files.length) return alert('请选择图片');

        const formData = new FormData();
        formData.append('image', fileInput.files[0]);
        formData.append('prompt', document.getElementById('prompt').value || '识别图片中的内容');

        resultEl.textContent = '正在识别，请稍候...';

        try {
            const start = performance.now();
            const resp = await fetch('/api/ocr', { method: 'POST', body: formData });
            const elapsed = Math.round(performance.now() - start);
            document.getElementById('status').textContent = resp.status + ' ' + resp.statusText;
            document.getElementById('elapsed').textContent = elapsed;

            let text = await resp.text();
            // 尝试解析为 JSON
            let parsed = null;
            try { parsed = JSON.parse(text); } catch(e) { parsed = null; }

            document.getElementById('rawText').textContent = text;
            document.getElementById('rawJson').textContent = parsed ? JSON.stringify(parsed, null, 2) : '(非 JSON)';

            if (resp.ok) {
              if (parsed && parsed.result) {
                resultEl.textContent = parsed.result;
              } else {
                resultEl.textContent = '(无识别结果)';
              }
            } else {
              resultEl.textContent = '识别失败: ' + (parsed?.error || resp.statusText || text);
            }

          } catch (err) {
            document.getElementById('status').textContent = 'network error';
            document.getElementById('rawText').textContent = '' + err;
            resultEl.textContent = '请求出错: ' + err.message;
          }
      });
    </script>
  </body>
</html>
