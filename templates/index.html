<html lang="zh-cn">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ai作业批改</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <meta name="server-prompt" content="{{ default_prompt|e }}">
  </head>
  <body>
    <div class="container">
      <!-- Hero Section -->
      <div class="hero-section">
        <h1 class="hero-title">
          <i class="fas fa-file-image"></i> Ai作业批改
        </h1>
        <p class="hero-subtitle">
          上传作业内容即可快速批改，也可上传普通图片进行文字识别
        </p>
      </div>

      <!-- Upload Section -->
      <div class="card">
        <h2 class="section-title">
          <i class="fas fa-cloud-upload-alt"></i>
          图片上传
        </h2>

        <div class="upload-section">
          <form id="uploadForm">
            <div class="form-group">
              <div class="file-input-wrapper">
                <input type="file" id="imageInput" name="image" accept="image/*" multiple required />
                <label for="imageInput" class="file-input-label" id="fileLabel">
                  <i class="fas fa-image fa-2x"></i>
                  <span>点击选择图片或拖拽到此处</span>
                </label>
              </div>
            </div>

            <div class="button-group">
              <button type="submit">
                <i class="fas fa-magic"></i>
                开始识别
              </button>
              <button type="button" class="secondary-btn" id="clearBtn">
                <i class="fas fa-times"></i>
                清除
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Results Section -->
      <div class="card">
        <h2 class="section-title">
          <i class="fas fa-chart-line"></i>
          识别结果
        </h2>

        <div id="statusIndicator" class="status-indicator processing" style="display: none;">
          <div class="loading-spinner"></div>
          <span>正在处理中...</span>
        </div>

        <div class="results-grid">
          <div class="result-card">
            <div class="card-header">
              <i class="fas fa-file-alt"></i>
              识别文本
            </div>
            <div id="result" class="result-content">
              （等待识别...）
            </div>
          </div>

          <div class="debug-card">
            <div class="card-header">
              <i class="fas fa-code"></i>
              调试信息
            </div>
            <pre id="rawJson" class="debug-content">(等待请求...)</pre>
          </div>
        </div>

        <!-- Preview Section -->
        <div class="preview-section">
          <div class="preview-header">
            <i class="fas fa-eye"></i>
            图片预览
          </div>
          <div id="previewGrid" style="display:grid;grid-template-columns:repeat(auto-fill,120px);gap:8px;margin-top:8px"></div>
        </div>
      </div>
    </div>
    <script>
      const form = document.getElementById('uploadForm');
      const resultEl = document.getElementById('result');
      const previewGrid = document.getElementById('previewGrid');
      const rawJsonEl = document.getElementById('rawJson');
      const fileInputEl = document.getElementById('imageInput');
      const fileLabel = document.getElementById('fileLabel');
      const clearBtn = document.getElementById('clearBtn');
      const statusIndicator = document.getElementById('statusIndicator');
      const uploadSection = document.querySelector('.upload-section');
      const _metaPrompt = document.querySelector('meta[name="server-prompt"]');
      window.SERVER_PROMPT = _metaPrompt ? _metaPrompt.getAttribute('content') : '';

      function resetFileLabel() {
        fileLabel.classList.remove('has-file');
        fileLabel.innerHTML = '<i class="fas fa-image fa-2x"></i><span>点击选择图片或拖拽到此处</span>';
      }

      // 图片选择后显示多个预览
      fileInputEl.addEventListener('change', () => {
        previewGrid.innerHTML = '';
        const files = Array.from(fileInputEl.files || []);
        if (files.length === 0) {
          resetFileLabel();
          return;
        }

        fileLabel.classList.add('has-file');
        fileLabel.innerHTML = `<i class="fas fa-check-circle fa-2x"></i><span>已选择 ${files.length} 张</span>`;

        files.forEach(file => {
          const wrap = document.createElement('div');
          wrap.style.textAlign = 'center';
          const img = document.createElement('img');
          img.src = URL.createObjectURL(file);
          img.style.width = '120px';
          img.style.height = '90px';
          img.style.objectFit = 'cover';
          img.style.borderRadius = '6px';
          img.style.border = '1px solid #e6eefc';
          const label = document.createElement('div');
          label.style.fontSize = '12px';
          label.style.marginTop = '6px';
          label.className = 'muted';
          label.textContent = file.name;
          wrap.appendChild(img);
          wrap.appendChild(label);
          previewGrid.appendChild(wrap);
        });
      });

      // 清除按钮
      clearBtn.addEventListener('click', () => {
        fileInputEl.value = '';
        previewGrid.innerHTML = '';
        resetFileLabel();
        resultEl.textContent = '（等待识别...）';
        rawJsonEl.textContent = '(等待请求...)';
        statusIndicator.style.display = 'none';
      });

      // 表单提交处理（批量）
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!fileInputEl.files.length) {
          showNotification('请选择至少一张图片', 'error');
          return;
        }

        const formData = new FormData();
        const files = Array.from(fileInputEl.files || []);
        files.forEach(f => formData.append('image', f));
        const serverPrompt = (window.SERVER_PROMPT !== undefined) ? window.SERVER_PROMPT : '';
        const promptEl = document.getElementById('prompt');
        const promptVal = promptEl ? promptEl.value : serverPrompt;
        formData.append('prompt', promptVal);

        // 准备并显示发送的数据摘要
        const sentObj = {
          prompt: promptVal,
          files: files.map(f => ({ name: f.name, type: f.type, size: f.size }))
        };

        // 显示加载状态
        statusIndicator.style.display = 'flex';
        statusIndicator.className = 'status-indicator processing';
        statusIndicator.innerHTML = '<div class="loading-spinner"></div><span>正在处理中...</span>';
        resultEl.textContent = '正在识别中，请稍候...';
        rawJsonEl.textContent = 'Sent:\n' + JSON.stringify(sentObj, null, 2) + '\n\nReceived:\n(等待响应...)';

        try {
          const start = performance.now();
          const resp = await fetch('/api/ocr', { method: 'POST', body: formData });
          const elapsed = Math.round(performance.now() - start);
          const text = await resp.text();
          let parsed = null;
          try { parsed = JSON.parse(text); } catch (e) { parsed = null; }

          rawJsonEl.textContent = 'Sent:\n' + JSON.stringify(sentObj, null, 2) + '\n\nReceived:\n' + (parsed ? JSON.stringify(parsed, null, 2) : text);

          if (resp.ok) {
            statusIndicator.className = 'status-indicator success';
            statusIndicator.innerHTML = `<i class="fas fa-check-circle"></i><span>识别完成 (${elapsed}ms)</span>`;

            if (parsed && parsed.results && Array.isArray(parsed.results)) {
              resultEl.innerHTML = '';
              parsed.results.forEach(r => {
                const block = document.createElement('div');
                block.style.padding = '8px';
                block.style.borderBottom = '1px solid #eef2ff';
                const name = document.createElement('div');
                name.style.fontWeight = '600';
                name.textContent = r.filename || '(unknown)';
                const textEl = document.createElement('div');
                textEl.style.marginTop = '6px';
                textEl.textContent = r.result || (r.error || '(无识别结果)');
                const meta = document.createElement('div');
                meta.className = 'muted';
                meta.style.marginTop = '6px';
                meta.textContent = r.elapsed_ms ? ('耗时: ' + r.elapsed_ms + ' ms') : '';
                block.appendChild(name);
                block.appendChild(textEl);
                block.appendChild(meta);
                resultEl.appendChild(block);
              });
            } else if (parsed && parsed.result) {
              resultEl.textContent = parsed.result;
            } else {
              resultEl.textContent = '(无识别结果)';
            }
          } else {
            statusIndicator.className = 'status-indicator error';
            statusIndicator.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>识别失败</span>';
            resultEl.textContent = '识别失败: ' + (parsed?.error || resp.statusText || text);
          }
        } catch (err) {
          statusIndicator.className = 'status-indicator error';
          statusIndicator.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>请求出错</span>';
            rawJsonEl.textContent = 'Sent:\n' + JSON.stringify(sentObj, null, 2) + '\n\nError:\n' + (err && err.message ? err.message : String(err));
          resultEl.textContent = '请求出错: ' + (err.message || err);
        }
      });

      // 通知函数
      function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 16px 20px;
          border-radius: 12px;
          color: white;
          font-weight: 500;
          z-index: 1000;
          animation: slideInRight 0.3s ease-out;
          box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
        `;
        const colors = {
          error: 'linear-gradient(135deg, #ef4444, #dc2626)',
          success: 'linear-gradient(135deg, #10b981, #059669)',
          info: 'linear-gradient(135deg, #6366f1, #4f46e5)'
        };
        notification.style.background = colors[type] || colors.info;
        notification.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${message}`;
        document.body.appendChild(notification);
        setTimeout(() => {
          notification.style.animation = 'fadeOut 0.3s ease-out';
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      }

      // 添加必要的动画样式
      const styleEl = document.createElement('style');
      styleEl.textContent = `
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
      `;
      document.head.appendChild(styleEl);

      // 拖拽上传支持
      uploadSection.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadSection.style.borderColor = 'var(--accent)';
        uploadSection.style.background = '#f8faff';
      });
      uploadSection.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadSection.style.borderColor = 'var(--border)';
        uploadSection.style.background = 'linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%)';
      });
      uploadSection.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadSection.style.borderColor = 'var(--border)';
        uploadSection.style.background = 'linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%)';
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type.startsWith('image/')) {
          try { fileInputEl.files = files; } catch (err) {
            // fallback: create DataTransfer
            const dataTransfer = new DataTransfer();
            Array.from(files).forEach(f => dataTransfer.items.add(f));
            fileInputEl.files = dataTransfer.files;
          }
          const event = new Event('change', { bubbles: true });
          fileInputEl.dispatchEvent(event);
        } else {
          showNotification('请选择有效的图片文件', 'error');
        }
      });

    </script>
  </body>
</html>
