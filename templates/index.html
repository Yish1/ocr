pip install -r requirements.txt<!doctype html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OCR 前端</title>
    <style>
      :root{--bg:#f5f7fb;--card:#ffffff;--accent:#2874f0;--muted:#6b7280}
      body{font-family:Inter,Segoe UI, Roboto, sans-serif;background:var(--bg);color:#111;margin:0;padding:32px}
      .container{max-width:900px;margin:0 auto}
      .card{background:var(--card);border-radius:12px;box-shadow:0 6px 18px rgba(16,24,40,0.06);padding:20px}
      h2{margin:0 0 8px 0}
      p.lead{color:var(--muted);margin-top:0}
      form{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
      input[type=file]{border:1px dashed #d1d5db;padding:10px;border-radius:8px;background:#fbfdff}
      input[type=text]{padding:10px;border-radius:8px;border:1px solid #e6e9ef;flex:1;min-width:220px}
      button{background:var(--accent);color:#fff;padding:10px 14px;border-radius:8px;border:0;cursor:pointer}
      button:disabled{opacity:0.6;cursor:not-allowed}
      .result{white-space:pre-wrap;background:#f6f8ff;padding:16px;border-radius:8px;margin-top:12px;border:1px solid #e6eefc}
      .grid{display:grid;grid-template-columns:1fr 360px;gap:16px;margin-top:16px}
      .debug{background:#0f172a;color:#e6f0ff;padding:12px;border-radius:8px;overflow:auto;max-height:300px}
      .preview{max-height:220px;object-fit:contain;border-radius:8px;border:1px solid #e6eefc;background:#fff;padding:6px}
      .muted{color:var(--muted);font-size:13px}
    </style>
  </head>
  <body>

    <div class="card">

      <h2 style="margin-top:0">OCR 前端</h2>
      <p class="lead">选择图片并提交，识别结果与原始 JSON 返回将在右侧显示。</p>

    <form id="uploadForm">
      <div>
        <input type="file" id="imageInput" name="image" accept="image/*" multiple required />
      </div>
      <div style="margin-top:8px">
        <input type="text" id="prompt" name="prompt" placeholder="提示词（可选）" style="width:60%" value="{{ default_prompt }}" />
      </div>
      <div style="margin-top:12px">
        <button type="submit">上传并识别</button>
      </div>
    </form>

    <h3>识别结果</h3>
    <div class="grid">
      <div>
        <div id="result" class="result">（等待识别）</div>
        <div style="margin-top:12px" class="muted">已上传图片预览：</div>
        <div id="previewGrid" style="display:grid;grid-template-columns:repeat(auto-fill,120px);gap:8px;margin-top:8px"></div>
      </div>
      <div>
        <div style="margin-bottom:8px;color:#cbd5e1;font-size:13px">调试 — 原始 JSON</div>
        <pre id="rawJson" class="debug">(等待请求)</pre>
      </div>
    </div>
    </div>

    <script>
      const form = document.getElementById('uploadForm');
      const resultEl = document.getElementById('result');
      const previewGrid = document.getElementById('previewGrid');
      const rawJsonEl = document.getElementById('rawJson');

      // 图片选择后显示多个预览
      const fileInputEl = document.getElementById('imageInput');
      fileInputEl.addEventListener('change', () => {
        previewGrid.innerHTML = '';
        const files = Array.from(fileInputEl.files || []);
        files.forEach(file => {
          const wrap = document.createElement('div');
          wrap.style.textAlign = 'center';
          const img = document.createElement('img');
          img.src = URL.createObjectURL(file);
          img.style.width = '120px';
          img.style.height = '90px';
          img.style.objectFit = 'cover';
          img.style.borderRadius = '6px';
          img.style.border = '1px solid #e6eefc';
          const label = document.createElement('div');
          label.style.fontSize = '12px';
          label.style.marginTop = '6px';
          label.className = 'muted';
          label.textContent = file.name;
          wrap.appendChild(img);
          wrap.appendChild(label);
          previewGrid.appendChild(wrap);
        });
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const fileInput = document.getElementById('imageInput');
        if (!fileInput.files.length) return alert('请选择图片');

        const formData = new FormData();
        const files = Array.from(fileInput.files || []);
        files.forEach(f => formData.append('image', f));
        formData.append('prompt', document.getElementById('prompt').value || '识别图片中的内容');

        resultEl.textContent = '正在识别，请稍候...';
        rawJsonEl.textContent = '(等待响应...)';

        try {
            const start = performance.now();
            const resp = await fetch('/api/ocr', { method: 'POST', body: formData });
            let text = await resp.text();
            let parsed = null;
            try { parsed = JSON.parse(text); } catch(e) { parsed = null; }

            rawJsonEl.textContent = parsed ? JSON.stringify(parsed, null, 2) : text;

            if (resp.ok) {
              // 处理批量返回
              if (parsed && parsed.results && Array.isArray(parsed.results)) {
                resultEl.innerHTML = '';
                parsed.results.forEach(r => {
                  const block = document.createElement('div');
                  block.style.padding = '8px';
                  block.style.borderBottom = '1px solid #eef2ff';
                  const name = document.createElement('div');
                  name.style.fontWeight = '600';
                  name.textContent = r.filename || '(unknown)';
                  const textEl = document.createElement('div');
                  textEl.style.marginTop = '6px';
                  textEl.textContent = r.result || (r.error || '(无识别结果)');
                  const meta = document.createElement('div');
                  meta.className = 'muted';
                  meta.style.marginTop = '6px';
                  meta.textContent = r.elapsed_ms ? ('耗时: ' + r.elapsed_ms + ' ms') : '';
                  block.appendChild(name);
                  block.appendChild(textEl);
                  block.appendChild(meta);
                  resultEl.appendChild(block);
                });
              } else if (parsed && parsed.result) {
                resultEl.textContent = parsed.result;
              } else {
                resultEl.textContent = '(无识别结果)';
              }
            } else {
              resultEl.textContent = '识别失败: ' + (parsed?.error || resp.statusText || text);
            }

        } catch (err) {
          rawJsonEl.textContent = '' + err;
          resultEl.textContent = '请求出错: ' + err.message;
        }
      });
    </script>
  </body>
</html>
